# Some Assembly Required 4

## Problem Description

[http://mercury.picoctf.net:13626/index.html](http://mercury.picoctf.net:13626/index.html)

## Hints

(None)

## Solution

Deobfuscated JS:

```javascript
let exports;

(async () => {
    let wasmBin = await fetch('./ZoRd23o0wd');
    let wasmInit = await WebAssembly.instantiate(await wasmBin.arrayBuffer());
    let wasmInstance = wasmInit.instance;
    exports = wasmInstance.exports;
})();

function onButtonPress() {
    let input = document.getElementById('input').value;
    for (let i = 0; i < input.length; i++) {
        exports.copy_char(input.charCodeAt(i), i);
    }
    exports.copy_char(0, input.length), exports.check_flag() == 1 ? document.getElementById('result').innerHTML = 'Correct!' : document.getElementById('result').innerHTML = 'Incorrect!';
}
```

This time, after decompiling, we see that there is a lot of code in the check_flag function, while the copy function is the same as the first problem. We have to deobfuscate check_flag, which will take a bit of time. Here is the pseudocode, in Python.

```python
data = [24, 106, 124, 97, 17, 56, 105, 55, 73, 89, 40, 10, 107, 76, 88, 104, 89, 28, 26, 119, 97, 61, 19, 86, 39, 10, 107, 27, 5, 61, 87, 64, 71, 123, 63, 60, 21, 2, 127, 95, 12]

def check_flag():
    for i in range(len(input_data)):
        input_data[i] ^= 20
        if i >= 1:
            input_data[i] ^= input_data[i - 1]
        if i >= 3:
            input_data[i] ^= input_data[i - 3]
        input_data[i] ^= i % 10
        if i % 2 == 1:
            input_data[i] ^= 8
        else:
            input_data[i] ^= 9
        if i % 3 > 0:
            if i % 3 != 1:
                input_data[i] ^= 5
            else:
                input_data[i] ^= 6
        else:
            input_data[i] ^= 7
    for i in range(0, len(input_data), 2):
        if i + 1 < len(input_data):
            input_data[i], input_data[i + 1] = input_data[i + 1], input_data[i]
    return input_data == data
```

Now, we see that there are two parts to the function. Because we only have the end result (stored in `data`), we will have to work backwards to reverse the operations. 

The second part of the function swaps every two characters, which we can easily reverse by just swapping them again.

The first part contains many xor operations, which depend on previous elements and other conditions. Since xor has symmetry, we can just apply these operations again in the same logical order to get the flag. The solution can be found in [solve.py](./solve.py).

## Flag

picoCTF{151c547b23dbf14bfd1fb3413d3df6e0}
